@using StackExchange.Opserver.Data.Redis
@model RedisMemoryAnalysis
@{
    Layout = "~/Views/Shared/Master.cshtml";
    var serverInfo = RedisInstance.GetInstance(Model.ConnectionInfo);
}
@helper TopKeys(KeyStats ks) {
    foreach (var tk in ks.TopKeys)
    {
@:@tk.Value (@tk.Key.ToComma() bytes)
    }
}
<h5 class="page-header">
    @Model.IconSpan() Memory Analysis of @Model.ConnectionInfo.Host:@Model.ConnectionInfo.Port.ToString() (@Model.ConnectionInfo.Name)
    <span class="text-muted small">
        (Database @Model.Database.ToString())
        - <span title="@(((int)Model.TotalTime.TotalMilliseconds).ToComma()) ms">Runtime: @Model.TotalTime.ToReadableString()</span>
        - Run @Model.CreationDate.ToRelativeTimeSpan()
    </span>
    <a class="pull-right" href="/redis/analyze/memory/clear?node=@serverInfo.Host:@serverInfo.Port.ToString()&db=@Model.Database.ToString()">Re-run analysis</a>
</h5>
<table class="table table-striped table-hover text-nowrap table-super-condensed table-responsive">
    <thead>
        <tr>
            <th>Key Pattern</th>
            <th>Count</th>
            <th>Bytes (Key)</th>
            <th>Bytes (Value)</th>
            <th>Bytes (Total)</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.ErrorMessage.HasValue())
        {
            <tr class="redis-error">
                <td colspan="5">Error: @Model.ErrorMessage</td>
            </tr>
        }
        @foreach (var s in Model.KeyStats.OrderByDescending(s => s.Value.TotalByteSize))
        {
            var ks = s.Value;
            if (s.Value.Count == 0)
            {
                continue;
            }
            <tr>
                <td title="Regex: @s.Key.Regex.ToString()
                    @TopKeys(s.Value) ">
                    @s.Key.Name
                </td>
                <td>@ks.Count.ToComma()</td>
                <td>@ks.KeyByteSize.ToComma()</td>
                <td>@ks.ValueByteSize.ToComma()</td>
                <td>@ks.TotalByteSize.ToComma()</td>
            </tr>
        }
    </tbody>
    <tfoot>
        <tr class="total-row">
            <td><b>Total</b></td>
            <td>@Model.Count.ToComma()</td>
            <td>@Model.KeyByteSize.ToHumanReadableSize()</td>
            <td>@Model.ValueByteSize.ToHumanReadableSize()</td>
            <td>@Model.TotalByteSize.ToHumanReadableSize()</td>
        </tr>
    </tfoot>
</table>
@if (Model.TopKeys.Any())
{
    <h5 class="page-header">
        Top Keys (by Size)
    </h5>
    <table class="table table-striped table-hover text-nowrap table-super-condensed table-responsive">
        <thead>
            <tr>
                <th>Category</th>
                <th>Key</th>
                <th>Bytes (Key)</th>
                <th>Bytes (Value)</th>
                <th>Bytes (Total)</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var tk in Model.TopKeys)
            {
                <tr>
                    <td>@tk.Matcher.Name</td>
                    <td>@tk.Name</td>
                    <td>@tk.KeyBytes.ToComma()</td>
                    <td>@tk.ValueBytes.ToComma()</td>
                    <td>@tk.TotalBytes.ToComma()</td>
                </tr>
            }
        </tbody>
    </table>
}